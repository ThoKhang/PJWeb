@{
    ViewData["Title"] = "Quản lý đơn hàng";
}

@section Styles {
    <link rel="stylesheet"
          href="https://cdn.datatables.net/1.13.6/css/jquery.dataTables.min.css" />
}

<!-- HEADER -->
<div class="admin-card p-3 mb-4 d-flex justify-content-between align-items-center flex-wrap gap-3">
    <div>
        <div class="crumb mb-1" style="font-size:12px;">
            Đơn hàng • Danh sách
        </div>
        <h2 class="mb-1 fw-bold">Quản lý đơn hàng</h2>
        <div class="text-muted" style="font-size:13px;">
            Theo dõi và cập nhật trạng thái đơn hàng trong hệ thống.
        </div>
    </div>
    <div class="card shadow-sm">
        <div class="card-body">

            <table id="tblDonHang"
                   class="table table-hover align-middle table-bordered w-100">
                <thead class="table-light">
                    <tr>
                        <th>Mã đơn</th>
                        <th>Khách hàng</th>
                        <th>SĐT giao hàng</th>
                        <th class="text-center">Trạng thái</th>
                        <th class="text-center">Thanh toán</th>
                        <th>Ngày đặt</th>
                    </tr>
                </thead>
            </table>

    <button class="btn-mini" id="btnRefreshDonHang">
        <i class="fa-solid fa-rotate me-1"></i> Làm mới
    </button>
</div>

<!-- TABLE -->
<div class="admin-card p-2">
    <div class="table-wrap">
        <table id="tblDonHang"
               class="table-admin display nowrap w-100">
            <thead>
                <tr>
                    <th>Mã đơn</th>
                    <th>Khách hàng</th>
                    <th>SĐT giao hàng</th>
                    <th class="text-center">Trạng thái</th>
                    <th class="text-center">Thanh toán</th>
                    <th>Ngày đặt</th>
                    <th class="text-center">Thao tác</th>
                </tr>
            </thead>
            <tbody>
            </tbody>
        </table>
    </div>
</div>


@section Scripts {

    <script>
        $(function () {

            let table = $("#tblDonHang").DataTable({
                processing: true,
                serverSide: false,
                responsive: true,
                autoWidth: false,
                order: [[0, "desc"]],
                ajax: {
                    url: "/api/admin/dondathang",
                    type: "GET",
                    dataSrc: ""
                },
                columns: [
                    { data: "idDonDat" },

                    {
                        data: "nguoiDung",
                        render: u => u?.userName ?? "---"
                    },

                    { data: "sdtGiaoHang" },

                    {
                        data: "trangThai",
                        className: "text-center",
                        render: s => {
                            let color = "secondary";
                            if (s === "Chờ xác nhận") color = "warning";
                            if (s === "Đã duyệt") color = "primary";
                            if (s === "Đang giao") color = "info";
                            if (s === "Đã giao") color = "success";

                            return `
                                <span class="badge bg-${color} trang-thai-don"
                                      data-status="${s}"
                                      style="cursor:pointer">
                                    ${s}
                                </span>`;
                        }
                    },

                    {
                        data: "daThanhToan",
                        className: "text-center",
                        render: v =>
                            v
                            ? `<span class="badge bg-success">Đã thanh toán</span>`
                            : `<span class="badge bg-danger">Chưa thanh toán</span>`
                    },

                    {
                        data: "ngayDat",
                        render: d => {
                            if (!d) return "";
                            let dt = new Date(d);
                            return isNaN(dt)
                                ? d
                                : dt.toLocaleDateString("vi-VN");
                        }
                    },

                    {
                        data: "idDonDat",
                        className: "text-center",
                        render: id =>
                            `<a href="/Admin/DonDatHang/Details?id=${id}"
                                class="btn btn-sm btn-info">
                                <i class="fa fa-eye"></i>
                            </a>`
                    }
                ],
                language: { url: "//cdn.datatables.net/plug-ins/1.13.6/i18n/vi.json" }
            });
                }
                ,
                {
                    data: 'daThanhToan',
                    className: 'text-center',
                    render: v => v
                        ? `<span class="badge bg-success">Đã thanh toán</span>`
                        : `<span class="badge bg-danger">Chưa thanh toán</span>`
                },
                {
                    data: 'ngayDat',
                    render: d => d ? new Date(d).toLocaleDateString('vi-VN') : ''
                }
            ]
        });
    });
</script>
<script>
    function getNextStatus(current) {
        switch (current) {
            case 'Chờ xác nhận': return 'Đã duyệt';
            case 'Đã duyệt': return 'Đang giao';
            case 'Đang giao': return 'Đã giao';
            default: return null;
        }
    }

    $(document).on('click', '.trang-thai-don', function () {
        const badge = $(this);
        const currentStatus = badge.data('status');
        const row = $('#tblDonHang').DataTable().row(badge.closest('tr')).data();

        if (currentStatus === 'Đã giao') return;

        const nextStatus = getNextStatus(currentStatus);
        if (!nextStatus) return;

        Swal.fire({
            title: 'Xác nhận thay đổi?',
            html: `
                <b>${currentStatus}</b>
                <br>→
                <br><b class="text-primary">${nextStatus}</b>
            `,
            icon: 'warning',
            showCancelButton: true,
            confirmButtonText: 'Xác nhận',
            cancelButtonText: 'Hủy',
            confirmButtonColor: '#3085d6',
            cancelButtonColor: '#d33'
        }).then((result) => {
            if (!result.isConfirmed) return;
            $.ajax({
                url: '/api/admin/dondathang/update-status',
                type: 'POST',
                contentType: 'application/json',
                data: JSON.stringify({
                    idDonDat: row.idDonDat,
                    trangThai: nextStatus
                }),
                success: function () {
                    Swal.fire({
                        icon: 'success',
                        title: 'Cập nhật thành công!',
                        timer: 1200,
                        showConfirmButton: false
                    });

            $("#btnRefreshDonHang").on("click", () => table.ajax.reload(null, false));

            function nextStatus(current) {
                if (current === "Chờ xác nhận") return "Đã duyệt";
                if (current === "Đã duyệt") return "Đang giao";
                if (current === "Đang giao") return "Đã giao";
                return null;
            }

            $("#tblDonHang").on("click", ".trang-thai-don", function () {

                const badge = $(this);
                const oldStatus = badge.data("status");
                const row = table.row(badge.closest("tr")).data();

                if (oldStatus === "Đã giao") return;

                const newStatus = nextStatus(oldStatus);
                if (!newStatus) return;

                Swal.fire({
                    title: "Xác nhận cập nhật?",
                    html: `<b>${oldStatus}</b> → <b class="text-primary">${newStatus}</b>`,
                    icon: "question",
                    showCancelButton: true,
                    confirmButtonText: "Xác nhận",
                    cancelButtonText: "Hủy",
                }).then(res => {
                    if (!res.isConfirmed) return;

                    $.ajax({
                        url: "/api/admin/dondathang/update-status",
                        type: "POST",
                        contentType: "application/json",
                        data: JSON.stringify({
                            idDonDat: row.idDonDat,
                            trangThai: newStatus
                        }),
                        success: () => {
                            Swal.fire("OK!", "Cập nhật thành công", "success");
                            table.ajax.reload(null, false);
                        },
                        error: () => Swal.fire("Lỗi", "Không cập nhật được", "error")
                    });
                });

            });

        });
    </script>

}
