@{
    ViewData["Title"] = "Quản lý đơn hàng";
}

@section Styles {
    <link rel="stylesheet" href="https://cdn.datatables.net/1.13.6/css/jquery.dataTables.min.css" />
}

<!-- HEADER -->
<div class="admin-card p-3 mb-4 d-flex justify-content-between align-items-center flex-wrap gap-3">
    <div>
        <div class="crumb mb-1" style="font-size:12px;">
            Đơn hàng • Danh sách
        </div>
        <h2 class="mb-1 fw-bold">Quản lý đơn hàng</h2>
        <div class="text-muted" style="font-size:13px;">
            Theo dõi và cập nhật trạng thái đơn hàng trong hệ thống.
        </div>
    </div>

    <button class="btn-mini" type="button" id="btnRefreshDonHang">
        <i class="fa-solid fa-rotate me-1"></i> Làm mới
    </button>
</div>

<!-- TABLE -->
<div class="admin-card p-2">
    <div class="table-wrap">
        <table id="tblDonHang" class="table-admin display nowrap w-100">
            <thead>
                <tr>
                    <th>Mã đơn</th>
                    <th>Khách hàng</th>
                    <th>SĐT giao hàng</th>
                    <th class="text-center">Trạng thái</th>
                    <th class="text-center">Thanh toán</th>
                    <th>Ngày đặt</th>
                </tr>
            </thead>
            <tbody></tbody>
        </table>
    </div>
</div>

@section Scripts {
    @* Nếu Layout CHƯA load jQuery thì bỏ comment dòng này *@
    @* <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.4/jquery.min.js"></script> *@

    <!-- DataTables JS (bắt buộc) -->
    <script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>

    <!-- SweetAlert2 (bạn dùng Swal) -->
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

    <script>
        $(function () {
            const $tbl = $("#tblDonHang");
            if ($tbl.length === 0) return;

            // tránh init lặp nếu partial render lại
            if ($.fn.DataTable.isDataTable($tbl)) {
                $tbl.DataTable().destroy();
            }

            const table = $tbl.DataTable({
                processing: true,
                serverSide: false,
                responsive: true,
                autoWidth: false,
                order: [[0, "desc"]],
                ajax: {
                    url: "/api/admin/dondathang",
                    type: "GET",
                    dataSrc: function (json) {
                        // API có thể trả: [] hoặc { data: [] }
                        if (Array.isArray(json)) return json;
                        if (json && Array.isArray(json.data)) return json.data;
                        return [];
                    }
                },
                columns: [
                    { data: "idDonDat" },

                    {
                        data: "nguoiDung",
                        render: function (u) {
                            return u && u.userName ? u.userName : "---";
                        }
                    },

                    { data: "sdtGiaoHang" },

                    {
                        data: "trangThai",
                        className: "text-center",
                        render: function (s) {
                            let color = "secondary";
                            if (s === "Chờ xác nhận") color = "warning";
                            if (s === "Đã duyệt") color = "primary";
                            if (s === "Đang giao") color = "info";
                            if (s === "Đã giao") color = "success";

                            return `
                                <span class="badge bg-${color} trang-thai-don"
                                      data-status="${s}"
                                      style="cursor:pointer">
                                    ${s}
                                </span>`;
                        }
                    },

                    {
                        data: "daThanhToan",
                        className: "text-center",
                        render: function (v) {
                            return v
                                ? `<span class="badge bg-success">Đã thanh toán</span>`
                                : `<span class="badge bg-danger">Chưa thanh toán</span>`;
                        }
                    },

                    {
                        data: "ngayDat",
                        render: function (d) {
                            if (!d) return "";
                            const dt = new Date(d);
                            return isNaN(dt.getTime()) ? d : dt.toLocaleDateString("vi-VN");
                        }
                    }
                ],
                language: { url: "//cdn.datatables.net/plug-ins/1.13.6/i18n/vi.json" }
            });

            // Làm mới
            $("#btnRefreshDonHang").on("click", function () {
                table.ajax.reload(null, false);
            });

            function getNextStatus(current) {
                switch (current) {
                    case "Chờ xác nhận": return "Đã duyệt";
                    case "Đã duyệt": return "Đang giao";
                    case "Đang giao": return "Đã giao";
                    default: return null;
                }
            }

            // Click badge trạng thái để update
            $tbl.on("click", ".trang-thai-don", function () {
                const badge = $(this);
                const currentStatus = badge.data("status");
                const row = table.row(badge.closest("tr")).data();

                if (!row) return;
                if (currentStatus === "Đã giao") return;

                const nextStatus = getNextStatus(currentStatus);
                if (!nextStatus) return;

                Swal.fire({
                    title: "Xác nhận thay đổi?",
                    html: `<b>${currentStatus}</b><br>→<br><b class="text-primary">${nextStatus}</b>`,
                    icon: "question",
                    showCancelButton: true,
                    confirmButtonText: "Xác nhận",
                    cancelButtonText: "Hủy",
                    confirmButtonColor: "#3085d6",
                    cancelButtonColor: "#d33"
                }).then((result) => {
                    if (!result.isConfirmed) return;

                    $.ajax({
                        url: "/api/admin/dondathang/update-status",
                        type: "POST",
                        contentType: "application/json",
                        data: JSON.stringify({
                            idDonDat: row.idDonDat,
                            trangThai: nextStatus
                        }),
                        success: function () {
                            Swal.fire({
                                icon: "success",
                                title: "Cập nhật thành công!",
                                timer: 1200,
                                showConfirmButton: false
                            });
                            table.ajax.reload(null, false);
                        },
                        error: function () {
                            Swal.fire("Lỗi", "Không cập nhật được trạng thái!", "error");
                        }
                    });
                });
            });
        });
    </script>
}
